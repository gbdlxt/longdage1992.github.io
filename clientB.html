<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Zego Express Video Call</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <script src="./jZego-rtc-2.7.0.js"></script>
        <script src="../js/ZegoRTMEvent.js"></script>
        <link rel="stylesheet" href="../css/styles.css">
    </head>
    <body>
        <h1>Zego RTC Video Call</h1>
        <button onclick="editorContraints()">修改约束</button>
        <button onclick="pull()">拉流</button>
        <hr>
        <div class="video-wrapper">
            <video id="local-video" autoplay muted playsinline controls></video>
            <video id="remote-video" autoplay muted playsinline controls></video>
        </div>
        <div id="information"></div>
    </body>
    <script>
        let zg;
        let token = null;
        let roomId = 'room0001';
        let role = 2;// 1 主播，2 观众
        let localVideo = document.querySelector('#local-video');
        let remoteVideo = document.querySelector('#remote-video');
        let mediaStreamConstraints = {
            "minBitRate": 800,
            "maxBitRate": 1500,
            "width": 800,
            "height": 600,
            "noiseSuppression": false,
            "autoGainControl": false,
            "echoCancellation": false
        };
        let reConstraints = {
            "minBitRate": 600,
            "maxBitRate": 1500,
            "width": 600,
            "height": 400,
            "noiseSuppression": true,
            "autoGainControl": true,
            "echoCancellation": true
        };
        let streamId = 's0001';
        // 初始化实例
        zg = new ZegoClient();

        // 配置必要参数
        _config = {
            "appid": 1739272706, // 必填，应用id，请从 即构管理控制台-https://console.zego.im 获取
            "idName": 'misaiya', // 必填，用户自定义id，全局唯一    
            "nickName": '弥赛亚', // 必填，用户自定义昵称
            "server": "wss://webliveroom-test.zego.im/ws", // 必填，接入服务器地址，请从 即构管理控制台-https://console.zego.im 获取
            "logLevel": 1, //日志级别，debug:0,info:1,warnn:2,error:3,report:99,disable:100（数字越大，日志越少），建议选择 1
            "logUrl": "", // 非必填，logServer 地址，请从 即构管理控制台-https://console.zego.im 获取
            "remoteLogLevel": 0, // 上传日志最低级别，建议跟 logLevel 一致
            "audienceCreateRoom": true //是否允许观众创建房间，默认为true
        }
        zg.config(_config);

        zg.onDisconnect = function(err) {
            // 网络断开后的回调处理
            console.warn('[onDisconnect]', err);
        }

        zg.onKickOut = function (err) {
            // 踢出房间后的回调处理
            console.warn('[onKickOut]', err);
        }

        zg.onGetAnchorInfo = function (anchor_userid, anchro_username) {
            // 主播信息更新回调处理，在登录成功后触发
            console.warn('[onGetAnchorInfo]', anchor_userid, anchro_username);
        }

        zg.onPublishStateUpdate = function (type, streamId, error) {
            // 推流状态变更通知
            console.warn('[onPublishStateUpdate]', type, streamId, error);
        }

        zg.onPublishQualityUpdate = function (streamId, streamQuality) {
            // 推流质量回调
            console.warn('[onPublishQualityUpdate]', streamId, streamQuality);
        }

        function editorContraints() {
            zg.setPublishStreamConstraints(streamId, reConstraints,  s=> {
                console.error('[setPublishStreamConstraints success]', s);
                // zg.startPublishingStream(streamId, localVideo);
            }, error=> console.error('[setPublishStreamConstraints]', error));

        }

        function pull() {
            zg.startPlayingStream(streamId, remoteVideo)
        }

        function getToken() {
            fetch(`https://wsliveroom-alpha.zego.im:8282/token?app_id=${_config.appid}&id_name=${_config.idName}&cgi_token=`)
                .then(rsp=> rsp.text())
                .then(rsp=> {
                    token = rsp;
                    zg.login(roomId, role, token, streamlist => {
                        // 登录成功后处理，例如预览推拉流
                        console.log('[登录成功]', streamlist);
                        zg.startPreview(localVideo, mediaStreamConstraints, s=> {
                            console.error('[startPreview success]', s);
                            zg.startPublishingStream(streamId, localVideo);
                            
                        }, error=> console.error('[startPreview]', error))
                    }, err => {
                        // 登录失败后处理
                        console.log('[登录失败]', err);
                    })
            });
        }
        getToken();

    </script>
</html>